#!/bin/bash

set -eu
set -o pipefail

if [ "${1:-}" = "-h" ] || [  "${1:-}" = "--help" ]; then
    echo
    echo "Reinitialize .git directory with remotes and branches from a .gitremote file"
    echo
    echo "Line format in .gitremote file:"
    echo "    <remote-name> <remote-url> [branch]"
    echo
    echo "Pass the values directly as arguments to skip the .gitremote file:"
    echo "    git-reinitialize <remote> <url> [branch]"
    echo
    exit 0
fi


add_remote() {
    local remote="$1"
    local url="$2"
    local branch="${3:-}"

    # if git has remote
    if git remote | grep -q "^$remote$"; then
        >&2 echo "git remote $remote already exists"

        local option=
        read -p "delete? y/n> " -n1 option
        if [ "$option" = "y" ]; then
            git remote remove "$remote"
        else
            return
        fi
    fi

    >&2 echo "Adding remote $remote from $url"
    git remote add "$remote" "$url"
    git fetch "$remote"

    if [ "$remote" = "origin" ]; then
        if [ "$branch" = "" ]; then
            branch="$(git remote show $remote | sed -n '/HEAD branch/s/.*: //p')"
        fi

        if [ "$(git branch --show-current)" != "$branch" ]; then
            git switch -c "$branch"
        fi

        git reset "$remote/$branch"

        git branch --set-upstream-to $remote/$branch
    fi

}



if [ ! -d .git ]; then
    git init
fi


if [ "${1:-}" != "" ]; then
    add_remote $1 $2 ${3:-}
    exit 0
fi

if [ ! -f .gitremote ]; then
    >&2 echo "No .gitremote file found"
    exit 1
fi

# This loop is weird but needed. The file descriptor trick is required to keep
# the script interactive inside the loop so read prompts can be used. The IFS=
# ensures files without ending newlines are read correctly.

# Open the file on file descriptor 3
exec 3< .gitremote

while IFS= read -r line <&3
do
    # Skip empty lines and comments
    if [ "$line" = "" ] || [ "${line:0:1}" = "#" ]; then
        continue
    fi

    add_remote $(echo "$line" | envsubst)
done

# Close file descriptor 3
exec 3<&-
